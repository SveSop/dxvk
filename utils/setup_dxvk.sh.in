#!/bin/bash

export WINEDEBUG=-all

dxvk_dir="$(dirname "$(dirname "$(readlink -fm "$0")")")"
quiet=false
assume=

function ask {
    echo "$1"
    if [ -z "$assume" ]; then
        read continue
    else
        continue=$assume
        echo "$continue"
    fi
}

POSITIONAL=()
while [[ $# -gt 0 ]]; do

    case $1 in
    -y)
        assume='y'
        shift
        ;;
    -n)
        assume='n'
        shift
        ;;
    -q|--quiet)
        quiet=true
        assume=${assume:-'y'}
        shift 
        ;;
    *)
        POSITIONAL+=("$1")
        shift
        ;;
    esac
done
set -- "${POSITIONAL[@]}"

if [ "$quiet" = true ]; then
    exec >/dev/null
fi

if [ -z "$WINEPREFIX" ]; then
    ask "WINEPREFIX is not set, continue? (y/N)"
    if [ "$continue" != "y" ] && [ "$continue" != "Y" ]; then
    exit 1
    fi
else
    if ! [ -f "$WINEPREFIX/system.reg" ]; then
        ask "WINEPREFIX does not point to an existing wine installation. Proceeding will create a new one, continue? (y/N)"
        if [ "$continue" != "y" ] && [ "$continue" != "Y" ]; then
        exit 1
        fi
    fi
fi

echo Detecting WINE_ARCH
get_wine_arch=$(wine reg QUERY "HKLM\System\CurrentControlSet\Control\Session Manager\Environment" /v PROCESSOR_ARCHITECTURE)

if [[ $get_wine_arch == *"x86"* ]]; then
      echo "Prefix is x86"
      wine_arch='x86'
      wine='wine'
elif [[ $get_wine_arch == *"AMD64"* ]]; then
      echo "Prefix is x86_64"
      wine_arch='x86_64'
      wine='wine64'
else
        echo "Unknown wine architecture"
fi

unix_sys_path=$( winepath -u c:\\windows )

ret=0

function removeOverride {
    echo "    [1/2] Removing override... "
    $wine reg delete 'HKEY_CURRENT_USER\Software\Wine\DllOverrides' /v $1 /f > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "    No dll-override found for $1"
    fi
    if [ $wine_arch == 'x86' ]; then
    	local dll="$unix_sys_path/system32/$1.dll"
    	echo "    [2/2] Removing 32-bit link... "
    	if [ -h "$dll" ]; then
        	out=$(rm "$dll" 2>&1)
        	if [ $? -ne 0 ]; then
            	ret=2
            	echo -e "$out"
        	fi
    	else
        	echo -e "'$dll' is not a link or doesn't exist."
        	ret=2
    	fi
    fi
    if [ $wine_arch == 'x86_64' ]; then
	local dll32="$unix_sys_path/syswow64/$1.dll"
        echo "    [2/2] Removing 32-bit link... "
        if [ -h "$dll32" ]; then
                out=$(rm "$dll32" 2>&1)
                if [ $? -ne 0 ]; then
                ret=2
                echo -e "$out"
                fi
        else
                echo -e "'$dll32' is not a link or doesn't exist."
                ret=2
        fi
        local dll64="$unix_sys_path/system32/$1.dll"
        echo "    [2/2] Removing 64-bit link... "
        if [ -h "$dll64" ]; then
                out=$(rm "$dll64" 2>&1)
                if [ $? -ne 0 ]; then
                ret=2
                echo -e "$out"
                fi
        else
                echo -e "'$dll64' is not a link or doesn't exist."
                ret=2
        fi
    fi
}

function createOverride {
    echo "    [1/2] Creating override... "
    $wine reg add 'HKEY_CURRENT_USER\Software\Wine\DllOverrides' /v $1 /d native /f >/dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo -e "Failed"
        exit 1
    fi
    if [ $wine_arch == 'x86' ]; then
    	if [ ! -e "$dxvk_dir/x32/$1.$dll_ext" ]; then
           echo "    No $dll_ext file found!"
           exit 1
    	fi
	echo "    [2/2] Creating 32-bit link to $1.$dll_ext... "
    	ln -sf "$dxvk_dir/x32/$1.$dll_ext" "$unix_sys_path/system32/$1.dll"
    	if [ $? -ne 0 ]; then
        	echo -e "Failed"
        	exit 1
    	fi
    fi
    if [ $wine_arch == 'x86_64' ]; then
	if [ ! -e "$dxvk_dir/x32/$1.$dll_ext" ]; then
           echo "    No $dll_ext file found!"
           exit 1
        fi
	echo "    [2/2] Creating 32-bit link to $1.$dll_ext... "
        ln -sf "$dxvk_dir/x32/$1.$dll_ext" "$unix_sys_path/syswow64/$1.dll"
        if [ $? -ne 0 ]; then
                echo -e "Failed"
                exit 1
        fi
        echo "    [2/2] Creating 64-bit link to $1.$dll_ext... "
        if [ ! -e "$dxvk_dir/x64/$1.$dll_ext" ]; then
           echo "    No $dll_ext file found!"
           exit 1
        fi
	ln -sf "$dxvk_dir/x64/$1.$dll_ext" "$unix_sys_path/system32/$1.dll"
        if [ $? -ne 0 ]; then
                echo -e "Failed"
                exit 1
        fi
    fi
}

case "$1" in
uninstall)
    fun=removeOverride
    ;;
install)
    case "$2" in
    dll)
	dll_ext='dll'
 	;;
    winelib)
	dll_ext='dll.so'
	;;
    *)
	echo "Unrecognized option: $2"
	echo "Usage: $0 [install|uninstall] [dll|winelib] [-q|--quiet] [-y|-n]"
	exit 1
	;;
    esac
    fun=createOverride
    ;;
*)
    echo "Unrecognized option: $1"
    echo "Usage: $0 [install|uninstall] [-q|--quiet] [-y|-n]"
    exit 1
    ;;
esac

echo '[1/5] dxgi:'
$fun dxgi
echo '[2/5] d3d10:'
$fun d3d10
echo '[3/5] d3d10_1:'
$fun d3d10_1
echo '[4/5] d3d10core:'
$fun d3d10core
echo '[5/5] d3d11:'
$fun d3d11
echo "    Making sure everything is working"
wineboot -u
exit $ret
